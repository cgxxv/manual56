### 13.7.2. 表维护语句

#### [13.7.2.1 ANALYZE TABLE语法](#13.7.2.1)

```sql
ANALYZE [NO_WRITE_TO_BINLOG | LOCAL] TABLE
    tbl_name [, tbl_name] ...
```

ANALYZE TABLE为表分析和存储密钥分配。在分析过程中，表对于InnoDB和MyISAM读锁定。该语句适用于InnoDB，NDB和MyISAM表。对于MyISAM表，该语句相当于使用myisamchk --analyze。

关于在InnoDB内分析如何进行的更多信息，请参阅[Section 14.2.4.2.10, “Persistent Optimizer Statistics for InnoDB Tables”][14.02.04.02.10] 和[Section 14.2.7, “Limits on InnoDB Tables”][14.02.07] 。特别是，当启用innodb_stats_persistent[1782][] 项时，你必须在加载主要数据到InnoDB表，或创建一个新的索引后运行ANALYZE TABLE。
后。

MySQL使用存储的密钥分配来决定当你加入常数以外的其他值时应加入哪张表的顺序。此外，当在查询中决定哪些索引用于指定表中时，可以使用密钥分配。

这个语句需要给表授予SELECT [775][] 和INSERT [775][] 权限。

ANALYZE TABLE支持分区表，您可以使用ALTER TABLE...ANALYZE PARTITION来分析一个或多个分区；有关详细信息，请参阅[Section 13.1.7, “ALTERTABLE Syntax”][13.01.07] 和[Section 18.3.4, “Maintenance of Partitions”][18.03.04] 。

仅仅只在MySQL5.6.11中，必须在写下该语句前将gtid_next[2060][] 设置为AUTOMATIC。（错误＃16715809，错误＃16062608，错误＃69045）

ANALYZE TABLE返回的结果设置于以下列中.

<table summary="This table describes the columns of the
    ANALYZE TABLE result
    set." border="1"><colgroup><col><col></colgroup><thead>
<tr>
    <th scope="col">Column</th><th scope="col">Value</th>
</tr></thead><tbody>
<tr>
    <td scope="row"><code class="literal">Table</code></td><td>表名</td>
</tr>
<tr>
    <td scope="row"><code class="literal">Op</code></td><td>总是<code class="literal">analyze</code></td>
</tr>
<tr>
    <td scope="row"><code class="literal">Msg_type</code></td><td><code class="literal">status</code>, <code class="literal">error</code>,<code class="literal">info</code>, <code class="literal">note</code>或者<code class="literal">warning</code></td>
</tr>
<tr>
    <td scope="row"><code class="literal">Msg_text</code></td><td>信息报文</td>
</tr></tbody></table>

您可以使用[SHOW INDEX][] 查看存储的密钥分配。请参阅[Section 13.7.5.23,“SHOW INDEX Syntax”][13.07.05.23]。

如果表自最后一个ANALYZE TABLE语句都没有改变，则该表不会再次被分析。

默认情况下，服务器将ANALYZE TABLE语句写入二进制日志，让他们复制到复制从服务器。为了封锁记录，指定可选的NO_WRITE_TO_BINLOG关键字或其LOCAL别名。

#### [13.7.2.2 CHECK TABLE语法](#13.7.2.2)

```sql
CHECK TABLE tbl_name [, tbl_name] ... [option] ...
option = {FOR UPGRADE | QUICK | FAST | MEDIUM | EXTENDED | CHANGED}
```

CHECK TABLE为一张表或多张表检查错误。CHECK TABLE适用于[InnoDB][14.02.00], [MyISAM][14.03.00] , [ARCHIVE][14.06.00] 以及 [CSV][14.05.00] 表。对于MyISAM表来说，关键数据也会被更新。

为了检查表，你必须对其拥有一些权限。

CHECK TABLE也能检查视图的问题，比如表涉及的视图定义不再存在。

CHECK TABLE支持分区表，您可以使用ALTER TABLE ... CHECK PARTITION来检查一个或多个分区；有关详细信息，请参阅[Section 13.1.7, “ALTER TABLE Syntax”][13.01.07] 和[Section 18.3.4, “Maintenance of Partitions”][18.03.04] 。

仅仅只在MySQL5.6.11中，必须在写下该语句前将gtid_next[2060][] 设置为AUTOMATIC。（错误＃16062608，错误＃16715809，错误＃69045）

#### 输出

CHECK TABLE返回的结果设置于以下列中.

<table summary="This table describes the columns of the
          CHECK TABLE result
          set." border="1"><colgroup><col><col></colgroup><thead>
<tr>
    <th scope="col">Column</th><th scope="col">Value</th>
</tr></thead><tbody>
<tr>
    <td scope="row"><code class="literal">Table</code></td><td>表名</td>
</tr>
<tr>
    <td scope="row"><code class="literal">Op</code></td><td>总是 <code class="literal">check</code></td>
</tr>
<tr>
    <td scope="row"><code class="literal">Msg_type</code></td><td><code class="literal">status</code>, <code class="literal">error</code>,
                <code class="literal">info</code>, <code class="literal">note</code>或者 <code class="literal">warning</code></td>
</tr>
<tr>
    <td scope="row"><code class="literal">Msg_text</code></td><td>信息报文</td>
</tr></tbody></table>

请注意，该语句会为每个检查表产生多行信息。最后一行具有一个Msg_type的status值且Msg_text通常为OK。如果你没有获得OK，或者Table is already up to date，您通常应该运行表的修复。请参阅[Section 7.6, “MyISAM Table Maintenance and Crash Recovery”][07.06.00]。Table is already up to date 表示表的存储引擎指出没有检查表的必要。

#### 检查版本兼容性

FOR UPGRADE项检查已命名表与MySQL的当前版本是否兼容。使用FOR UPGRADE，服务器检查每张表以确定从创建表开始，表的数据类型或索引中是否有任何不兼容的改变。如果没有则检查完成。否则，如果没有可能的不兼容项，服务器对表进行全面检查（这可能会花费一些时间）。如果全面检查完成，服务器使用当前MySQL版本号标记表的.frm 文件。标记.frm 文件能确有保相同服务器版本的表的深度检查会更快。

因为数据类型的存储格式或者排列的顺序发生了改变，就会发生不兼容的现象。我们的目的是避免这些改变，但在某些情况下，有可能改正问题将比版本之间的不兼容更差。

目前，FOR UPGRADE 发现了以下不兼容现象：

* 在MySQL4.1和5.0版本中InnoDB 和MyISAM 表的TEXT[] 列end-space的索引顺序发生了改变。
* 在MySQL5.0.3和5.0.5版本中DECIMAL[]数据类型的存储方式发生了改变。
* 如果表由不同于当前运行版本的MySQL服务器来创建的话，FOR UPGRADE提示表有一个不兼容版本的[.frmp][]文件。这种情况下，CHECK TABLE返回的结果集包含一行[Msg_type][]值为[error][]，[Msg_text][]值为[Table upgrade required. Please do "REPAIR TABLE
`tbl_name`" to fix it!][]。
* 在MySQL5.6.5中[YEAR(2)](#The_YEAR_Type)被弃用了。CHECK TABLE[]推荐使用REPAIR TABLE[]来处理这种数据类型的表。用REPAIR TABLE[]转换[YEAR(2)](#The_YEAR_Type) 为 [YEAR(4)](#The_YEAR_Type)。

#### [检查数据一致性](#Checking_Data_Consistency)
下表列出了其它可用的检查选项。这些选项传递到存储引擎，存储引擎不一定会使用这些选项。

<table summary="This table describes other CHECK TABLE options." border="1"><colgroup><col><col></colgroup><thead><tr><th scope="col">Type</th><th scope="col">Meaning</th></tr></thead><tbody>

<tr>
<td scope="row">
    <code class="literal">QUICK</code></td><td>不扫描每一行来检查不正确的链接。应用到
    <code class="literal">InnoDB</code> 和 <code class="literal">MyISAM</code>
    表和视图中。
</td>
</tr>
<tr>
<td scope="row"><code class="literal">FAST</code></td><td>只检查没有被正确关闭的表。应用于
                <code class="literal">MyISAM</code> 表和视图；
                <code class="literal">InnoDB</code>会忽略掉</td>
</tr><tr><td scope="row"><code class="literal">CHANGED</code></td><td>只有在上一次检查以后有修改或者没有被正确关闭时才会进行检查。应用于
                <code class="literal">MyISAM</code> 表和视图；
                <code class="literal">InnoDB</code>会忽略掉。</td>
</tr><tr><td scope="row"><code class="literal">MEDIUM</code></td><td>扫描每一行验证已删除的连接是合法的。并且计算每一行的校验和，和之前已经计算好的校验和进行验证。应用于
                <code class="literal">MyISAM</code> 表和视图；
                <code class="literal">InnoDB</code>会忽略掉。</td>
</tr><tr><td scope="row"><code class="literal">EXTENDED</code></td><td>对每一行的所有key做一个完整的检查。确保表是100%一致的，但是会花费比较长的时间。应用于
                <code class="literal">MyISAM</code> 表和视图；
                <code class="literal">InnoDB</code>会忽略掉。</td>
</tr>
</tbody></table>
