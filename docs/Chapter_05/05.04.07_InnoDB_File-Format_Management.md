###05.04.07 Enabling File Formats

参数innodb_file_format控制了CREATE TABLE 和 ALTER TABLE 是否可以创建基于Barracuda文件格式支持的表。

虽然Oracle建议在实际中新表使用Barracuda文件格式，在MySQL 5.5 中默认的文件格式任然是Antelope，缘于为了最大程度上建议不同MySQL发行版本的复制同步配置。

文件格式是动态，全局变量，可以在配置文件（my.cnf,my.ini）中指定，或者使用SET GLOBAL 命令。

####5.4.7.2 确认文件格式的兼容性

InnoDB 1.1 中做了多个检查来防止在一个老版本的MySQL实例上使用较新的文件格式从而可能导致的崩溃和文件损坏。这个检查在系统启动时开始工作，以及你第一个次访问某个表。这一章节讲诉了这些检查，你如何控制它们，以及可能出现的经过和错误信息。

<b>向后兼容性</b>

向后兼容性只考虑使用较新办法的InnoDB（MySQL 5.1或更早，或者包含InnoDB 1.1 的MySQL 5.5）在老版本的MySQL上（MySQL 5.1 或更早，带有内置的InnoDB引起而不是InnoDB插件）。为了最小话兼容性风险，你可以使用InnoDB插件引擎作为所有MySQL 5.1 和之前的实例。

 一般来说，一个新版本的InnDB可能创建一个表或者索引，而不能被之前版本的innoDB安全地读或者或写，排除了崩溃，阻塞，结果错误或中断带来的风险。InnoDB 1.1 中包含防卫这些条件的算法，以保护数据库文件和不同版本的InnoDB的兼容性。这些算法让你可以使用InnoDB发布后的一些新功能（例如性能优化和bug 解决），同样保护你得数据库包含一个之前版本的InnoDB的选项,通过阻止在创建向下不兼容的磁盘文件时使用了新功能来实现。
 
如果一个版本的InnoDB只一个具体的文件格式（不管这个格式是否为默认），你可以查询和更新该格式或之前更早的格式的数据表。只有使用新特性创建的表受到特定启用的文件格式的限制。相反，如果一个表空间包含一个表或者索引使用一个当前运行软件不支持的文件格式，则它不能不被访问，即使只是读操作。降级InnoDB表空间到一个之前版本文件格式的唯一方法是拷贝数据到一个新表，一个使用较早版本文件格式的表空间。可以通过语句ALTER TABLE 语句实现，详见：Section 5.4.7.4, “Downgrading the File Format”.
	
判断一个InnoDB 表空间的文件格式最简单的方法是检查其包含的表的属性。使用命令SHOW TABLE STATUS或者查询表INFOMATION_SCHEMA.TABLES。如果Row_format为‘Compressed‘ 或’Dynamic‘，则表空间中包含的表使用Barracuda格式。其他的情况时，他使用InnoDB之前的文件格式，Antelope。

<b>内部细节</b>

每一个InnoDB独立表空间（命名为*.ibd文件）文件都包含一个文件格式的标签。系统表空间（命名为ibdata文件）为一组InnoDB 数据库文件，使用一个’最高‘的标签，这些标签在这些文件打开会被检查。

<b>ib-file集定义</b>
 
为了避免混淆，这里讨论我们定义’ib-file集‘为一组InnoDB以一个单元来管理的操作系统文件。ib-file包含以下的文件：

* 系统表空间（一个或多个ibdata文件），包含内部系统信息（包含内部目录和撤销日志），用户数据和索引。
* 0或者更多的独立表空间（也称为’每个表一个文件‘，命名为 *.ibd文件）
* InnoDB 日志文件；通常为2个，ib_logfile0 和ib_logfile1.用于崩溃恢复和备份。

一个“Ib-file 集”不包含相应的存储InnoDB表元数据信息的.frm文件。.frm文件为MySQL创建和管理，有时候会和InnoDB中的元数据表不一致。

多个表，甚至是来自多个不同的库，可以存储在一个“ib-file 集”。（在MySQL中，一个“database” 是一系列表的逻辑集合，在其他的系统中被称为“schema”或者“catlog”）。

#####5.4.7.2.1. InnoDB 启动时的兼容性检查
为了防止InnoDB打开一个ib-file集时可能引起的崩溃或数据损坏，它检查自己可以完全支持ib-file集中使用的文件格式。如果系统在崩溃后重启，或者一次“快速关闭”（比如，innodb_fast_shutdown大于0），可能会存在磁盘数据结构（例如重做或撤销尸体，或者双写数据页）使用对于当前软件“过于新”的文件格式。在恢复过程中，如果数据结构被访问，将发生一系列的数据文件损坏。启动过程在恢复过程开始之前检查文件格式，这样可以防止新表的一致性问题或者MySQL 服务器的启动问题。
 
 从InnoDB 1.0.1开始，系统表空间记录了ib-file集中所有表空间中所有表使用的最高的文件格式。对文件格式的检查由配置参数innodb_file_format_check控制，默认为ON。

 如果系统表空间的文件格式标记新于或高于当前运行的软件支持的最高版本，且innodb_file_format_check为ON，系统启动时将出现以下的错误:
 	
 	 ￼InnoDB: Error: the system tablespace is in a file format that this version doesn't support

你也可以设置innodb_file_format 为一个文件格式名字。这样做可以防止InnoDB在当前软件不支持指定的文件格式时启动。这同样设置了你指定的值为’最高水位线‘。设置innodb_file_format_check同样在你手动降级（见 Downgrading the InnoDB Storage Engine）一个ib-file 集中所有的表是有用（未来的InnoDB发布版）。

在一些限制场景，你可能希望ib-file集使用一个“较新”的文件格式（当前使用的软件不支持的格式）来启动服务器。如果你设置innodb_file_format_check 为OFF，InnoDB 打开数据库，但是会在日志文件中记录下面的警告信息：
	
	￼InnoDB: Warning: the system tablespace is in a	file format that this version doesn't support
注意：
这是很危险的配置，他允许恢复线程运行，如果上一次关闭是崩溃或快速关闭可能会导致数据库损坏。你只能在确认上一次关闭是以innodb_fast_shutdown=0进行才设置innodb_file_format_check为OFF，这样就不会有恢复线程的运行。在未来的发行版中，这个参数的配置将从OFF更名为UNSAFE。（然而，直到未来新的InnoDB支持额外的文件格式，禁止启动检查实际上也是安全的）。
参数innodb_file_format_check 只会在一个数据库打开时产生影响，不是之后。相反的，参数innodb_file_format（启用一个指定的文件格式）只决定是否一个新表可以以启动的格式创建，而对一个数据库是否创建不产生影响。
文件格式标记是一个“最高水位线”，即使这样，它会在服务器启动后会增长，如果一个使用更高格式的表被创建或一个已经存在的表被访问或更新（假设它的格式是支持的）。如果你访问一个已经存在的使用一个当前软件支持的最高格式的表，系统表空间标记不会被更新，但是表级的兼容性检查执行（产生一个错误），见Section 5.4.7.2.2, “Compatibility Check When a Table Is Opened”。任何时候最高水位线被更新，参数innodb_file_format_check的值也同步更新，查看命令SELECT @@innodb_file_format_check；显示了当前运行的软件和当前打开的ib-file 集中最高的文件格式的名称。
